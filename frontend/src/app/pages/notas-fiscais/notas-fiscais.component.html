<div class="notas-fiscais-container">
  <h2>Lista de Notas Fiscais</h2>

  <button (click)="mostrarFormulario = true">Nova Nota Fiscal</button>
  <div *ngIf="erroCarregamento" class="erro-mensagem">
    {{ erroCarregamento }}
  </div>

  <div *ngIf="mostrarFormulario" class="form-container">
    <h3>Nova Nota Fiscal</h3>
    <form (ngSubmit)="criarNotaFiscal()">
      <div>
        <label>Status: <strong>Aberta</strong></label>
      </div>

      <div class="selecao-produto">
        <h4>Selecionar Produto</h4>

        <div *ngIf="produtosDisponiveis.length === 0">
          <p>Nenhum produto cadastrado no sistema.</p>
        </div>

        <div *ngIf="produtosDisponiveis.length > 0">
          <div>
            <label>Produto:</label>
            <select [(ngModel)]="produtoSelecionadoId" name="produto" required>
              <option value="0">Selecione um produto</option>
              <option *ngFor="let produto of produtosDisponiveis" [value]="produto.id">
                {{ produto.codigo }} - {{ produto.descricao }} (Saldo: {{ produto.saldo }})
              </option>
            </select>
          </div>

          <div>
            <label>Quantidade:</label>
            <input
              type="number"
              [(ngModel)]="quantidadeSelecionada"
              name="quantidade"
              min="1"
              max="100"
              required
              style="width: 80px"
            />
          </div>
        </div>
      </div>

      <button type="submit" [disabled]="produtoSelecionadoId === 0 || quantidadeSelecionada <= 0">
        Criar Nota Fiscal
      </button>
      <button type="button" (click)="cancelar()">Cancelar</button>
    </form>
  </div>

  <div *ngIf="notasFiscais.length === 0">
    <p>Nenhuma nota fiscal cadastrada.</p>
  </div>

  <div *ngIf="notasFiscais.length > 0">
    <table>
      <thead>
        <tr>
          <th>Numeração</th>
          <th>Status</th>
          <th>Produto</th>
          <th>Quantidade</th>
          <th>Saldo Anterior</th>
          <th>Novo Saldo</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let nota of notasFiscais">
          <td>{{ nota.numeracao }}</td>
          <td>{{ nota.status }}</td>
          <td>{{ obterNomeProduto(nota.itens[0]?.produtoId || 0) }}</td>
          <td>{{ nota.itens[0]?.quantidade || 0 }}</td>
          <td>{{ obterSaldoAnterior(nota) }}</td>
          <td>{{ obterSaldoAtual(nota) }}</td>
          <td>
            <button
              (click)="imprimirNota(nota)"
              [disabled]="nota.status !== 'Aberta'"
              class="btn-imprimir"
            >
              {{ carregandoImpressao === nota.id ? 'Imprimindo...' : 'Imprimir' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>